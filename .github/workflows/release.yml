# This is a basic workflow to help you get started with Actions

name: tag & release

# Controls when the action will run. 
on:
  push:
    tags: 
      - '*'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  Test:
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '5.0.x'
      - name: Run Tests
        run: |
          cd src
          dotnet nuget add source https://nuget.pkg.github.com/PlayCade/index.json -u hevey -n github -p ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text
          dotnet test
  # This workflow contains a single job called "build"
  BuildTagAndRelease:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: Test
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: Setup .NET Core 5
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '5.0.x'
      - name: Install dotnet tool
        run: dotnet tool install -g dotnetCampus.TagToVersion
      - name: Set tag to version  
        run: |
          cd src
          dotnet TagToVersion -t ${{ github.ref }}
          
      - name: Build with dotnet
        run: |
          mkdir ${{ github.workspace }}/package
          cd src
          dotnet build --configuration Release --output ${{ github.workspace }}/package

      - name: Install Nuget
        uses: nuget/setup-nuget@v1
        with:        
          nuget-version: '5.x'

      - name: Add private GitHub registry to NuGet
        run: |
          nuget sources add -name github -Source https://nuget.pkg.github.com/PlayCade/index.json -Username PlayCade -Password ${{ secrets.GITHUB_TOKEN }}
      - name: Push generated package to GitHub registry
        run: |
          nuget push ${{ github.workspace }}/package/*.nupkg -Source github -SkipDuplicate
        # nuget push ${{ github.workspace }}/package/*.nupkg -Source https://api.nuget.org/v3/index.json -SkipDuplicate -ApiKey ${{ secrets.NugetKey }} -NoSymbols 
